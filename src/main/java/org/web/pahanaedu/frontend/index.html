<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pahana Edu - Customer Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="mb-4 text-center">Pahana Edu - Customer Management</h1>

    <!-- Add Customer Form -->
    <div class="card mb-4">
        <div class="card-header">Add New Customer</div>
        <div class="card-body">
            <form id="customerForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="accountNumber" class="form-control" placeholder="Account Number" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="name" class="form-control" placeholder="Customer Name" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="phone" class="form-control" placeholder="Phone" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="address" class="form-control" placeholder="Address" required>
                    </div>
                    <div class="col-md-6">
                        <input type="number" id="unitsConsumed" class="form-control" placeholder="Units Consumed" required>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">Add Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="card">
        <div class="card-header">Customer List</div>
        <div class="card-body">
            <table class="table table-striped" id="customerTable">
                <thead>
                <tr>
                    <th>Account #</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Units</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const apiUrl = "http://localhost:8080/api/customers";

    let isEditMode = false;
    let editAccountNumber = null;

    document.addEventListener("DOMContentLoaded", () =>
    {
        fetchCustomers();

        document.getElementById("customerForm").addEventListener("submit", async (e) =>
        {
            e.preventDefault();

            const customer =
                {
                accountNumber: document.getElementById("accountNumber").value,
                name: document.getElementById("name").value,
                phone: document.getElementById("phone").value,
                address: document.getElementById("address").value,
                unitsConsumed: parseInt(document.getElementById("unitsConsumed").value)
            };

            let res;
            if (isEditMode)
            {
                res = await fetch(`${apiUrl}/${editAccountNumber}`,
                    {
                    method: "PUT",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(customer)
                });
            }
            else
            {
                res = await fetch(apiUrl,
                    {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(customer)
                });
            }

            if (res.ok)
            {
                fetchCustomers();
                e.target.reset();
                isEditMode = false;
                editAccountNumber = null;
                document.querySelector("#customerForm button").textContent = "Add Customer";
            }
            else
            {
                alert("Error saving customer.");
            }
        });
    });

    async function fetchCustomers()
    {
        const res = await fetch(apiUrl);
        const data = await res.json();

        const tbody = document.querySelector("#customerTable tbody");
        tbody.innerHTML = "";

        data.forEach(c =>
        {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${c.accountNumber}</td>
              <td>${c.name}</td>
              <td>${c.phone}</td>
              <td>${c.address}</td>
              <td>${c.unitsConsumed}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2" onclick="editCustomer('${c.accountNumber}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.accountNumber}')">Delete</button>
              </td>
            `;

            tbody.appendChild(row);
        });
    }

    async function deleteCustomer(accountNumber) {
        if (!confirm("Are you sure you want to delete this customer?")) return;

        const res = await fetch(`${apiUrl}/${accountNumber}`, {method: "DELETE"});
        if (res.ok) {
            fetchCustomers();
        } else {
            alert("Failed to delete customer.");
        }
    }

    async function editCustomer(accountNumber) {
        const res = await fetch(`${apiUrl}/${accountNumber}`);
        if (!res.ok) return alert("Customer not found.");

        const customer = await res.json();

        // Fill form with customer data
        document.getElementById("accountNumber").value = customer.accountNumber;
        document.getElementById("name").value = customer.name;
        document.getElementById("phone").value = customer.phone;
        document.getElementById("address").value = customer.address;
        document.getElementById("unitsConsumed").value = customer.unitsConsumed;

        // Switch to edit mode
        isEditMode = true;
        editAccountNumber = accountNumber;

        // Update button text
        document.querySelector("#customerForm button").textContent = "Update Customer";

        // Optional: disable account number so it can't be changed
        document.getElementById("accountNumber").disabled = true;
    }

</script>

</body>
</html>
